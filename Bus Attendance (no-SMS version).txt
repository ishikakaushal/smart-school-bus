/* Bus Attendance (no-SMS version) 
   Uses RC522 RFID. Two cards prefilled from your scan.
   UIDs: 9F146A1F and 741EADA3
*/

#include <SPI.h>
#include <MFRC522.h>

#define SS_PIN 10
#define RST_PIN 9

MFRC522 mfrc522(SS_PIN, RST_PIN);

// --- Configure your students here ---
String studentUIDs[] = {
  "9F146A1F",   // card #1 (from your Serial Monitor)
  "741EADA3"    // card #2
};
String studentNames[] = {
  "Student1",   // replace with actual name for 9F146A1F
  "Student2"    // replace with actual name for 741EADA3
};
// -------------------------------------

const uint8_t studentCount = sizeof(studentUIDs) / sizeof(studentUIDs[0]);
bool onboard[10];               // onboard state per student (false = not on bus)
unsigned long lastActionTime[10]; // last action timestamp for each student
const unsigned long debounceMs = 1500UL; // ignore repeated scans within 1.5s

void setup() {
  Serial.begin(9600);
  while (!Serial) { ; } // wait for Serial (optional on some boards)
  SPI.begin();
  mfrc522.PCD_Init();

  Serial.println();
  Serial.println(F("--- Bus Attendance (No SMS) ---"));
  Serial.println(F("Scan one of the registered cards to toggle boarding status."));
  Serial.print(F("Registered students: "));
  Serial.println(studentCount);

  for (uint8_t i = 0; i < studentCount && i < 10; ++i) {
    onboard[i] = false;
    lastActionTime[i] = 0;
    Serial.print(i);
    Serial.print(F(": UID="));
    Serial.print(studentUIDs[i]);
    Serial.print(F("  Name="));
    Serial.println(studentNames[i]);
  }
  Serial.println();
}

void loop() {
  // look for new card
  if (!mfrc522.PICC_IsNewCardPresent()) return;
  if (!mfrc522.PICC_ReadCardSerial()) return;

  // build UID string (two hex digits per byte)
  String uid = "";
  for (byte i = 0; i < mfrc522.uid.size; i++) {
    byte b = mfrc522.uid.uidByte[i];
    if (b < 0x10) uid += "0";
    uid += String(b, HEX);
  }
  uid.toUpperCase();

  Serial.print("Card UID: ");
  Serial.println(uid);

  // find student index
  int idx = -1;
  for (uint8_t i = 0; i < studentCount; ++i) {
    if (uid == studentUIDs[i]) { idx = i; break; }
  }

  if (idx == -1) {
    Serial.println("Unknown card scanned!");
    mfrc522.PICC_HaltA();
    delay(500);
    return;
  }

  unsigned long now = millis();
  if (now - lastActionTime[idx] < debounceMs) {
    Serial.println("Ignored rapid re-scan.");
    mfrc522.PICC_HaltA();
    delay(300);
    return;
  }

  // toggle onboard state
  onboard[idx] = !onboard[idx];
  lastActionTime[idx] = now;

  String action = onboard[idx] ? "boarded" : "left";
  unsigned long timeSeconds = now / 1000UL;

  // Print friendly message
  Serial.print(studentNames[idx]);
  Serial.print(" (UID ");
  Serial.print(studentUIDs[idx]);
  Serial.print(") has ");
  Serial.print(action);
  Serial.print(" the bus.  Time(s): ");
  Serial.println(timeSeconds);

  // If you later enable SMS, call your sendSMS(...) here.
  // Example placeholder:
  // if (enableSMS) sendSMS(parentPhones[idx], studentNames[idx] + " has " + action);

  mfrc522.PICC_HaltA();
  delay(400);
}